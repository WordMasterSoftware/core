# WordMaster Backend

WordMaster æ™ºèƒ½èƒŒå•è¯ç³»ç»Ÿåç«¯ API

## ğŸš€ å¿«é€Ÿå¼€å§‹

**é€‰é¡¹1ï¼šä½¿ç”¨é¢„æ„å»ºçš„Dockeré•œåƒ**

å¦‚æœæ‚¨åªæƒ³å¿«é€Ÿè¿è¡ŒWordMasteråç«¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨é¢„æ„å»ºçš„Dockeré•œåƒï¼š

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull ghcr.io/wordmastersoftware/core:latest

# å¯åŠ¨æœåŠ¡ï¼ˆéœ€è¦å…ˆé…ç½®.envæ–‡ä»¶ï¼‰
cp .env.example .env  # é…ç½®æ‚¨çš„ç¯å¢ƒå˜é‡
docker-compose up -d
```


**é€‰é¡¹2ï¼šä½¿ç”¨é¢„æ„å»ºçš„é•œåƒä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰**

æ‚¨å¯ä»¥ç›´æ¥æ‹‰å–å¹¶ä½¿ç”¨é¢„æ„å»ºçš„é•œåƒï¼Œè€Œæ— éœ€æœ¬åœ°æ„å»ºï¼š

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull ghcr.io/wordmastersoftware/core:latest

# å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨é¢„æ„å»ºé•œåƒï¼‰
docker-compose up -d
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨


### 1. ç¯å¢ƒè¦æ±‚

- Python 3.10+
- PostgreSQL 14+
- pip

### 2. å®‰è£…ä¾èµ–

```bash
cd backend
pip install -r requirements.txt
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“è¿æ¥å’Œç³»ç»Ÿé»˜è®¤çš„ LLM é…ç½®ï¼š

```env
DATABASE_URL=postgresql://wordmaster:password@localhost:5432/postgres

# ç³»ç»Ÿé»˜è®¤çš„ LLM é…ç½®ï¼ˆç”¨æˆ·å¯ä»¥é€‰æ‹©ä½¿ç”¨æˆ–è‡ªå®šä¹‰ï¼‰
DEFAULT_LLM_API_KEY=your-api-key-here
DEFAULT_LLM_BASE_URL=https://api.openai.com/v1
DEFAULT_LLM_MODEL=gpt-4
```

### 4. åˆå§‹åŒ–æ•°æ®åº“

ç¡®ä¿ PostgreSQL å·²å®‰è£…å¹¶è¿è¡Œï¼Œç„¶åæ‰§è¡Œï¼š

```bash
# è¿æ¥åˆ° PostgreSQL
psql -U wordmaster -d postgres

# åœ¨ psql ä¸­æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
\i init_db.sql
```

æˆ–è€…ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œï¼š

```bash
psql -U wordmaster -d postgres -f init_db.sql
```

### 5. è¿è¡ŒæœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# æˆ–è€…ä½¿ç”¨ Python ç›´æ¥è¿è¡Œ
python -m app.main
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨

### 6. è®¿é—® API æ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€æŸ¥çœ‹ API æ–‡æ¡£ï¼š

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### ç”¨æˆ·çº§åˆ«çš„ LLM é…ç½®

æ¯ä¸ªç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š
- âœ… **ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®** - ä½¿ç”¨ `.env` ä¸­é…ç½®çš„ LLM API
- âœ… **ä½¿ç”¨è‡ªå®šä¹‰é…ç½®** - é…ç½®è‡ªå·±çš„ API Keyã€Endpoint å’Œ Model

**ä¼˜åŠ¿**ï¼š
- çµæ´»æ€§é«˜ï¼šä¸åŒç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¸åŒçš„ LLM æœåŠ¡
- æˆæœ¬æ§åˆ¶ï¼šç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªå·±çš„ API Key
- éšç§ä¿æŠ¤ï¼šAPI Key åŠ å¯†å­˜å‚¨ï¼Œä¸ä¼šåœ¨å“åº”ä¸­è¿”å›

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py          # æ•°æ®åº“è¿æ¥
â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py          # ç”¨æˆ·æ¨¡å‹ï¼ˆåŒ…å«LLMé…ç½®ï¼‰
â”‚   â”‚   â”œâ”€â”€ user_session.py
â”‚   â”‚   â”œâ”€â”€ wordbook.py
â”‚   â”‚   â”œâ”€â”€ word_collection.py
â”‚   â”‚   â””â”€â”€ user_word_item.py
â”‚   â”œâ”€â”€ schemas/             # Pydantic æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py          # åŒ…å«LLMé…ç½®Schema
â”‚   â”‚   â”œâ”€â”€ word.py
â”‚   â”‚   â”œâ”€â”€ study.py
â”‚   â”‚   â”œâ”€â”€ exam.py
â”‚   â”‚   â””â”€â”€ collection.py
â”‚   â”œâ”€â”€ api/                 # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py          # è®¤è¯ + LLMé…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ words.py
â”‚   â”‚   â”œâ”€â”€ study.py
â”‚   â”‚   â”œâ”€â”€ exam.py
â”‚   â”‚   â”œâ”€â”€ tts.py
â”‚   â”‚   â”œâ”€â”€ collections.py
â”‚   â”‚   â””â”€â”€ messages.py
â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_service.py
â”‚   â”‚   â”œâ”€â”€ word_service.py
â”‚   â”‚   â”œâ”€â”€ study_service.py
â”‚   â”‚   â”œâ”€â”€ exam_service.py
â”‚   â”‚   â”œâ”€â”€ llm_service.py   # æ”¯æŒç”¨æˆ·çº§åˆ«é…ç½®
â”‚   â”‚   â”œâ”€â”€ tts_service.py
â”‚   â”‚   â”œâ”€â”€ collection_service.py
â”‚   â”‚   â”œâ”€â”€ message_service.py
â”‚   â”‚   â””â”€â”€ tts_service.py
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ auth.py
â”‚       â”œâ”€â”€ dependencies.py
â”‚       â””â”€â”€ prompt_templates.py
â”œâ”€â”€ init_db.sql              # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env.example
â””â”€â”€ README.md
```

## ğŸ”Œ API æ¥å£

### è®¤è¯æ¨¡å— (`/api/auth`)

#### åŸºç¡€è®¤è¯
- `POST /api/auth/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/auth/login` - ç”¨æˆ·ç™»å½•
- `POST /api/auth/logout` - é€€å‡ºç™»å½•
- `GET /api/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
- `PUT /api/auth/profile` - æ›´æ–°ç”¨æˆ·èµ„æ–™
- `PUT /api/auth/password` - ä¿®æ”¹å¯†ç 

#### LLM é…ç½®ç®¡ç†
- `GET /api/auth/llm-config` - è·å–å½“å‰ç”¨æˆ·çš„ LLM é…ç½®
- `PUT /api/auth/llm-config` - æ›´æ–°ç”¨æˆ·çš„ LLM é…ç½®

**LLM é…ç½®ç¤ºä¾‹**ï¼š

```json
// ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®
PUT /api/auth/llm-config
{
  "use_default_llm": true
}

// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
PUT /api/auth/llm-config
{
  "use_default_llm": false,
  "llm_api_key": "sk-your-api-key",
  "llm_base_url": "https://api.openai.com/v1",
  "llm_model": "gpt-4"
}
```

### å•è¯ç®¡ç† (`/api/words`)

- `POST /api/words/import` - å¯¼å…¥å•è¯åˆ—è¡¨ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ LLM é…ç½®ï¼‰
- `GET /api/words/list` - è·å–ç”¨æˆ·å•è¯æœ¬
- `DELETE /api/words/{word_id}` - åˆ é™¤å•è¯

### å­¦ä¹ æ¨¡å— (`/api/study`)

- `GET /api/study/session` - è·å–å­¦ä¹ ä¼šè¯
- [æ›´å¤šå­¦ä¹ ç›¸å…³æ¥å£...]

### è€ƒè¯•æ¨¡å— (`/api/exam`)

- `POST /api/exam/generate` - ç”Ÿæˆè€ƒè¯•ï¼ˆè‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·çš„ LLM é…ç½®ï¼‰
- `POST /api/exam/submit` - æäº¤è€ƒè¯•ç­”æ¡ˆ

### TTS è¯­éŸ³ (`/api/tts`)

- `GET /api/tts/{word}` - è·å–å•è¯å‘éŸ³

### å•è¯æœ¬æ¨¡å— (`/api/collections`)

- `GET /api/collections` - è·å–ç”¨æˆ·å•è¯æœ¬
- `POST /api/collections` - åˆ›å»ºæ–°çš„å•è¯æœ¬
- `PUT /api/collections/{id}` - æ›´æ–°å•è¯æœ¬
- `DELETE /api/collections/{id}` - åˆ é™¤å•è¯æœ¬

### æ¶ˆæ¯æ¨¡å— (`/api/messages`)

- `GET /api/messages` - è·å–æ¶ˆæ¯å†å²
- [æ›´å¤šæ¶ˆæ¯ç›¸å…³æ¥å£...]

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·è¡¨ (users)

æ–°å¢å­—æ®µï¼š
- `use_default_llm` - æ˜¯å¦ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ LLM é…ç½®
- `llm_api_key` - ç”¨æˆ·è‡ªå®šä¹‰çš„ API Keyï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
- `llm_base_url` - ç”¨æˆ·è‡ªå®šä¹‰çš„ API Endpoint
- `llm_model` - ç”¨æˆ·è‡ªå®šä¹‰çš„ Model

### å…¶ä»–è¡¨

- **user_sessions** - ç”¨æˆ·ç™»å½•ä¼šè¯
- **wordbook** - å•è¯åº“ï¼ˆJSONB å­˜å‚¨ç¿»è¯‘ã€éŸ³æ ‡ã€ä¾‹å¥ï¼‰
- **word_collections** - å•è¯æœ¬åˆ†ç±»ç®¡ç†
- **user_word_items** - ç”¨æˆ·å­¦ä¹ è¿›åº¦ï¼ˆå››IDè®¾è®¡ï¼šcollection_id, user_id, word_id, item_itemï¼‰ï¼ˆ5ç§çŠ¶æ€ï¼š0-4ï¼‰
- **messages** - æ¶ˆæ¯å†å²è®°å½•

## ğŸ” LLM é…ç½®å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ³¨å†Œ/ç™»å½•                           â”‚
â”‚  é»˜è®¤ï¼šuse_default_llm = true            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š                          â”‚
â”‚  1ï¸âƒ£ ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é…ç½®ï¼ˆ.envï¼‰             â”‚
â”‚  2ï¸âƒ£ é…ç½®è‡ªå·±çš„ LLM API                  â”‚
â”‚     - API Key                           â”‚
â”‚     - Base URL                          â”‚
â”‚     - Model                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯¼å…¥å•è¯ / ç”Ÿæˆè€ƒè¯•æ—¶                   â”‚
â”‚  è‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·é…ç½®çš„ LLM                  â”‚
â”‚  - use_default_llm=true â†’ ç³»ç»Ÿé…ç½®      â”‚
â”‚  - use_default_llm=false â†’ ç”¨æˆ·é…ç½®     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ éƒ¨ç½²

### Docker éƒ¨ç½² (æ¨è)

æˆ‘ä»¬æä¾›äº† `docker-compose.yml` ä»¥ä¾¿å¿«é€Ÿå¯åŠ¨å®Œæ•´çš„åº”ç”¨ç¯å¢ƒï¼ˆåŒ…å«æ•°æ®åº“ï¼‰ã€‚

**é€‰é¡¹1ï¼šä½¿ç”¨é¢„æ„å»ºçš„é•œåƒï¼ˆæ¨èï¼‰**

æ‚¨å¯ä»¥ç›´æ¥æ‹‰å–å¹¶ä½¿ç”¨é¢„æ„å»ºçš„é•œåƒï¼Œè€Œæ— éœ€æœ¬åœ°æ„å»ºï¼š

```bash
# æ‹‰å–æœ€æ–°é•œåƒ
docker pull ghcr.io/wordmastersoftware/core:latest

# å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨é¢„æ„å»ºé•œåƒï¼‰
docker-compose up -d
```

**é€‰é¡¹2ï¼šä»æºç æ„å»º**

å¦‚æœæ‚¨æƒ³ä»æºç æ„å»ºé•œåƒï¼š

1. **å‡†å¤‡é…ç½®æ–‡ä»¶**

   å¤åˆ¶ç¤ºä¾‹é…ç½®å¹¶æ ¹æ®éœ€è¦ä¿®æ”¹ï¼ˆå¦‚ LLM API Keyï¼‰ï¼š
   ```bash
   cp .env.example .env
   ```

2. **æ„å»ºå¹¶å¯åŠ¨**

   ```bash
   docker-compose up -d --build
   ```

   è¿™å°†è‡ªåŠ¨ï¼š
   - å¯åŠ¨ PostgreSQL æ•°æ®åº“å¹¶åˆå§‹åŒ–æ•°æ®
   - æ„å»ºåç«¯é•œåƒ
   - å¯åŠ¨åç«¯æœåŠ¡

3. **è®¿é—®æœåŠ¡**

   åç«¯ API å°†åœ¨ `http://localhost:8000` ä¸Šå¯ç”¨ã€‚

4. **æŸ¥çœ‹æ—¥å¿—**

   ```bash
   docker-compose logs -f
   ```

5. **åœæ­¢æœåŠ¡**

   ```bash
   docker-compose down
   ```

**ä½¿ç”¨é¢„æ„å»ºé•œåƒçš„ä¼˜åŠ¿**

- æ›´å¿«çš„éƒ¨ç½²é€Ÿåº¦ï¼šæ— éœ€æœ¬åœ°æ„å»ºæ—¶é—´
- ä¸€è‡´çš„è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨å®˜æ–¹å‘å¸ƒçš„é•œåƒ
- å‡å°‘æœ¬åœ°ä¾èµ–ï¼šä¸éœ€è¦å®‰è£…Pythonç­‰ä¾èµ–é¡¹

### ä¼ ç»Ÿ Docker è¿è¡Œ

å¦‚æœä½ åªæƒ³å•ç‹¬è¿è¡Œåç«¯å®¹å™¨ï¼š

```bash
# 1. æ„å»ºé•œåƒ (æ³¨æ„ï¼š.dockerignore ä¼šæ’é™¤ .env æ–‡ä»¶ä»¥ä¿è¯å®‰å…¨)
docker build -t wordmaster-backend .

# 2. è¿è¡Œå®¹å™¨ (è¿è¡Œæ—¶æŒ‚è½½ .env)
docker run -p 8000:8000 --env-file .env wordmaster-backend
```

## ğŸ”§ æ•…éšœæ’é™¤

### LLM é…ç½®é—®é¢˜

**é—®é¢˜**ï¼šç”¨æˆ·ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åï¼Œå¤§æ¨¡å‹è°ƒç”¨å¤±è´¥

**è§£å†³**ï¼š
1. æ£€æŸ¥ç”¨æˆ·é…ç½®çš„ API Key æ˜¯å¦æœ‰æ•ˆ
2. æ£€æŸ¥ Base URL æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

### æ•°æ®åº“è¿æ¥å¤±è´¥

æ£€æŸ¥ PostgreSQL æ˜¯å¦è¿è¡Œï¼š
```bash
sudo systemctl status postgresql
```

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Request æ¥å¸®åŠ©æ”¹è¿›è¿™ä¸ªé¡¹ç›®ï¼

## ğŸ“„ è®¸å¯è¯

GNU GENERAL PUBLIC LICENSE Version 3